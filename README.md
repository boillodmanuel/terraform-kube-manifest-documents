# Kube Manifest Documents module

This terraform module helps to split a kubernetes multi-document manifest into several documents.
This is a replacement for the buggy [kubectl_file_documents](https://registry.terraform.io/providers/gavinbunney/kubectl/latest/docs/data-sources/kubectl_file_documents) data source from `alekc/kubectl` or `gavinbunney/kubectl` providers.

## Rationale

Under some unknown conditions, the `kubectl_file_documents` data source fails with these bugs:
- [#61 for_each on kubectl_path_documents errors with The "for_each" value depends on resource attributes that cannot be determined until apply](https://github.com/gavinbunney/terraform-provider-kubectl/issues/61)
- [#215 for_each on kubectl_path_documents errors with The "for_each" value depends on resource attributes that cannot be determined until apply](https://github.com/gavinbunney/terraform-provider-kubectl/issues/215)

To be noticed that:
- `gavinbunney/kubectl` provider is not maintained anymore since 2022.
- `alekc/kubectl` is a fork, still under development, but as of today, in the latest version `2.0.3`, the bugs are still presents.

This module is a replacement for this `kubectl_file_documents` data source.

Warning: the document ids generated by the module is slightly different from the datasource. 
The pattern used is: `/apis/{apiVersion}(/namespaces/{namespace})/{kind}/{name}`  where the `/namespaces/{namespace}` part is optional.

# Usage

## Example using `for_each`

To split and apply documents using `for_each`:

Note: This is the prefered way as mentioned in [kubectl_file_documents](https://registry.terraform.io/providers/alekc/kubectl/latest/docs/data-sources/kubectl_file_documents) documentation:
> This ensures that any additional yaml documents or removals do not cause a large amount of terraform changes

```terraform
# Split manifest into documents
module "my_manifest" {
  source = "<path_to>/kube-manifest-documents"
  content = file("${path.module}/manifests/my-manifest.yaml"
}

# Apply manifest documents using "alekc/kubectl" provider
resource "kubectl_manifest" "my_manifest_documents" {
  for_each = module.my_manifest.documents_per_id
  yaml_body = each.value
}
```

## Example using `count`

To split and apply documents using `count`: 

```terraform
# Split manifest into documents
module "my_manifest" {
  source = "<path_to>/kube-manifest-documents"
  content = file("${path.module}/manifests/my-manifest.yaml"
}

# Apply manifest documents using "alekc/kubectl" provider
resource "kubectl_manifest" "my_manifest_documents" {
  count = length(module.my_manifest.documents)
  yaml_body = module.my_manifest.documents[count.index]
}
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.0 |

## Providers

No providers.

## Modules

No modules.

## Resources

No resources.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_content"></a> [content](#input\_content) | Content of a multi-documents manifest. The content MUST be known before apply. | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_documents"></a> [documents](#output\_documents) | List of manifest documents |
| <a name="output_documents_per_id"></a> [documents\_per\_id](#output\_documents\_per\_id) | Map of manifest documents per id. The id is generated using this pattern: '/apis/{apiVersion}(/namespaces/{namespace})/{kind}/{name}' |
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

